<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Final Shot</title>
    <link rel="stylesheet" href="styles.css">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
</head>
<body>
    <div id="container" class="container">
        <div id="images-container" class="images-container"></div>
        
        <div id="focused-view" class="focused-view">
            <img id="focused-image" class="focused-image" src="" alt="Focused image">
        </div>
        
        <div id="cursor-label" class="cursor-label"></div>
        
        <div class="menu-bar">
            <div class="portfolio-name"><a href="/" style="text-decoration: none; color: inherit;">The Final Shot</a></div>
            
            <div class="menu-items">
                <div class="menu-item active" data-category="featured">
                    <span class="menu-icon">‚òÖ</span>
                    <span class="menu-text">Featured</span>
                </div>
                <div class="menu-item" data-category="bnw">
                    <span class="menu-icon">‚óê</span>
                    <span class="menu-text">BnW</span>
                </div>
                <div class="menu-item" data-category="about">
                    <span class="menu-icon">‚Ñπ</span>
                    <span class="menu-text">About</span>
                </div>
                <div class="menu-item mobile-hide-random-musings" data-category="random-musings" style="margin-left: 2em;">
                    <span class="menu-icon">üìù</span>
                    <span class="menu-text"><a href="/random-musings" class="random-musings-trigger" style="text-decoration: none; color: inherit;">Random Musings</a></span>
                </div>
            </div>
            
            <div class="right-controls">
                <div class="threshold-control">
                    <span>Threshold:</span>
                    <button class="threshold-btn" id="threshold-decrease">Ôºç</button>
                    <span id="threshold-value">0080</span>
                    <button class="threshold-btn" id="threshold-increase">Ôºã</button>
                </div>
                
                <div class="counter" id="counter">0000 / 0000</div>
            </div>
        </div>
    </div>
    
    <!-- External Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Cross-platform scroll utility -->
    <script src="scroll-utils.js"></script>
    
    <!-- Cloudinary browser library -->
    <script src="cloudinary-browser.js"></script>
    
    <!-- Main application script -->
    <script src="script.js"></script>
    
    <script>
        // Handle Random Musings navigation animation
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîß Setting up Random Musings click handler...');
            const randomMusingsTrigger = document.querySelector('.random-musings-trigger');
            console.log('üîç Found trigger element:', randomMusingsTrigger);
            
            if (randomMusingsTrigger) {
                randomMusingsTrigger.addEventListener('click', (e) => {
                    console.log('üéØ CLICK DETECTED! Starting preload + animation...');
                    e.preventDefault();

                    // üöÄ IMMEDIATELY start API fetch (parallel with animation)
                    console.log('üöÄ Starting preload fetch during animation...');
                    fetch('/api/notion-musings?pageSize=6')
                        .then(response => {
                            console.log('üì° Preload fetch response received');
                            return response.json();
                        })
                        .then(data => {
                            // Store preloaded data for instant page load
                            sessionStorage.setItem('preloadedMusings', JSON.stringify({
                                data: data,
                                timestamp: Date.now(),
                                pageIndex: 0
                            }));
                            console.log('üíæ Preloaded musings data cached successfully');
                        })
                        .catch(error => {
                            console.log('‚ö†Ô∏è Preload failed, will fallback to normal fetch:', error);
                            sessionStorage.removeItem('preloadedMusings');
                        });

                    // üõ°Ô∏è IMMEDIATELY disable Cloudinary handlers to prevent backup images
                    const container = document.getElementById('container');
                    if (container && window.handleCursorMove) {
                        container.removeEventListener('mousemove', window.handleCursorMove);
                        console.log('üö´ Disabled Cloudinary handlers for clean transition');
                    }
                    
                    // Start animation
                    const menuItems = document.querySelectorAll('.menu-item:not([data-category="random-musings"])');
                    const thresholdControl = document.querySelector('.right-controls');
                    const randomMusingsItem = document.querySelector('[data-category="random-musings"]');
                    
                    // Start preloading the page immediately
                    const preloadLink = document.createElement('link');
                    preloadLink.rel = 'prefetch';
                    preloadLink.href = '/random-musings';
                    document.head.appendChild(preloadLink);
                    
                    // Start loading API data
                    fetch('/api/notion-musings?pageSize=6').catch(() => {
                        // Preload API call, ignore errors
                    });
                    
                    // Sequential fade out: About ‚Üí BnW ‚Üí Featured (cascading effect)
                    const aboutItem = document.querySelector('[data-category="about"]');
                    const bnwItem = document.querySelector('[data-category="bnw"]');
                    const featuredItem = document.querySelector('[data-category="featured"]');
                    
                    // About fades first (0ms delay)
                    if (aboutItem) {
                        aboutItem.style.transition = 'opacity 1.5s ease, transform 1.5s ease';
                        aboutItem.style.opacity = '0';
                        aboutItem.style.transform = 'translateX(-10px)';
                    }
                    
                    // BnW fades second (200ms delay)
                    setTimeout(() => {
                        if (bnwItem) {
                            bnwItem.style.transition = 'opacity 1.5s ease, transform 1.5s ease';
                            bnwItem.style.opacity = '0';
                            bnwItem.style.transform = 'translateX(-10px)';
                        }
                    }, 200);
                    
                    // Featured fades last (400ms delay)
                    setTimeout(() => {
                        if (featuredItem) {
                            featuredItem.style.transition = 'opacity 1.5s ease, transform 1.5s ease';
                            featuredItem.style.opacity = '0';
                            featuredItem.style.transform = 'translateX(-10px)';
                        }
                    }, 400);
                    
                    // Fade out threshold control
                    if (thresholdControl) {
                        thresholdControl.style.transition = 'opacity 1.5s ease';
                        thresholdControl.style.opacity = '0';
                    }
                    
                    // Move Random Musings to center (with fallback)
                    if (randomMusingsItem) {
                        randomMusingsItem.style.transition = 'transform 1.5s ease';
                        
                        // Try dynamic centering using viewport center
                        try {
                            const viewportWidth = window.innerWidth;
                            const itemRect = randomMusingsItem.getBoundingClientRect();
                            const itemCenter = itemRect.left + (itemRect.width / 2);
                            const viewportCenter = viewportWidth / 2;
                            const centerOffset = viewportCenter - itemCenter;
                            
                            randomMusingsItem.style.transform = `translateX(${centerOffset}px)`;
                            console.log(`üéØ Viewport centering: offset=${centerOffset}px, itemCenter=${itemCenter}, viewportCenter=${viewportCenter}`);
                        } catch (error) {
                            console.log('‚ö†Ô∏è Viewport centering failed, using fallback', error);
                            randomMusingsItem.style.transform = 'translateX(-50px)';
                        }
                    }
                    
                    // Navigate after 1.5s animation (pseudo loader)
                    setTimeout(() => {
                        window.location.href = '/random-musings';
                    }, 1500);
                });
            }
        });
    </script>
</body>
</html>

